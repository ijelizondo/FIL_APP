<!DOCTYPE html> 
<html> 
    <head> 
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <title></title> 
    <link rel="stylesheet" href="js/jquery.mobile-1.1.0.min.css" />
	<script src="js/jquery-1.6.4.min.js"></script>
	<script src="js/jquery.mobile-1.1.0.min.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="js/main.js"></script>
    
<script>
//EDIT THESE LINES
//Title of the blog
var TITLE = "Raymond Camden's Blog";
//RSS url
var RSS = "http://biblioteca.mty.itesm.mx/mty/db/reports.php?base=mty_fil_avisos&report_id=1&accion=rss";
//Stores entries
var entries = [];
var selectedEntry = "";

//listen for detail links
$(".contentLink").live("click", function() {
	selectedEntry = $(this).data("entryid");
});

function renderEntries(entries) {
    var s = '';
    $.each(entries, function(i, v) {
        s += '<li><a href="#contentPage" class="contentLink" data-entryid="'+i+'">' + v.title + '</a></li>';
    });
    $("#linksList").html(s);
    $("#linksList").listview("refresh");
}

function checkCacheFalBack() {
	if(localStorage["entries"]) {
		$("#status").html("Usando versión actualizada previamente...");
		entries = JSON.parse(localStorage["entries"]);
		renderEntries(entries);
	} else {
		$("#status").html("Lo sentimos, no se pudo realizar la actualización y no exsite una copia local en tu disposutivo.");
	}
}

//Listen for Google's library to load
function initialize() {
	console.log('ready to use google');
	var feed = new google.feeds.Feed(RSS);
	feed.setNumEntries(10);
	$.mobile.showPageLoadingMsg();
	feed.load(function(result) {
		$.mobile.hidePageLoadingMsg();
		if(!result.error) {
			entries = result.feed.entries;
			localStorage["entries"] = JSON.stringify(entries);
			renderEntries(entries);
		} else {
			console.log("Error - "+result.error.message);
			checkCacheFalBack();
		}
	});
}

//Listen for main page
$("#mainPage").live("pageinit", function() {
	//Set the title
	$("h1", this).text(TITLE);
	
	try {
		google.load("feeds", "1",{callback:initialize});
	} catch(e) {
		console.log('Error - intentdo recuperar cache local');
		checkCacheFalBack();
	}
});

$("#mainPage").live("pagebeforeshow", function(event,data) {
	if(data.prevPage.length) {
		$("h1", data.prevPage).text("");
		$("#entryText", data.prevPage).html("");
	};
});

//Listen for the content page to load
$("#contentPage").live("pageshow", function(prepage) {
	//Set the title
	$("h1", this).text(entries[selectedEntry].title);
	#$("h1", this).html(contentHTML);
	var contentHTML = "";
	contentHTML += entries[selectedEntry].content;
	contentHTML += '<p/><a href="'+entries[selectedEntry].link + '">Read Entry on Site</a>';
	$("#entryText",this).html(contentHTML);
});
</script>    
    
</head>

<body>
<div data-role="page" id="mainPage">

    <div data-role="header">
        <h1></h1>
    </div>

    <div data-role="content">  
		<div id="status"></div>  
        <ul id="linksList" data-role="listview" data-inset="true"></ul>
    </div>

    <div data-role="footer">
        <h4><a href="http://biblioteca.mty.itesm.mx">Biblioteca Campus Monterrey</a></h4>
        <br />
        <h5>Tecnología e Innovación</h5>
    </div>

    
</div>

<div data-role="page" id="contentPage">

    <div data-role="header">
        <a href="#mainPage" data-rel="back">Inicio</a>
        <h1></h1>
    </div>

    <div data-role="content" id="entryText">
    </div>
        
</div>

</body>	
</html>